<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricket Score Counter</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* Custom styles for a more advanced UI */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }

        .main-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 1rem;
        }

        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
            overflow: hidden; /* Ensures content respects border-radius */
            transition: all 0.3s ease;
        }

        .card-header {
            background: linear-gradient(135deg, #4f46e5, #818cf8);
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
            border-bottom: 0;
            padding: 1.5rem;
        }

        .btn-primary {
            background-color: #4f46e5;
            border-color: #4f46e5;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background-color: #4338ca;
            border-color: #4338ca;
            transform: translateY(-2px);
        }
        
        .score-display {
            font-size: 4rem;
            font-weight: 900;
            color: #1e293b;
        }

        .overs-display {
            font-size: 1.5rem;
            color: #64748b;
            font-weight: 600;
        }

        .scoring-controls .btn {
            font-size: 1.2rem;
            font-weight: 700;
            padding: 1rem;
            margin: 0.25rem;
            border-radius: 0.75rem;
        }

        .player-info {
            font-size: 1.1rem;
        }

        .match-id-display {
            background-color: #eef2ff;
            color: #4338ca;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .match-id-display:hover {
            background-color: #e0e7ff;
        }

        #scoreboardView, #matchEndView { display: none; }
        
        /* --- Custom Modal Styles --- */
        .custom-modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1040;
            align-items: center;
            justify-content: center;
        }
        .custom-modal {
            width: 90%;
            max-width: 500px;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        .custom-modal-header {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .custom-modal-title {
            margin-bottom: 0;
            font-size: 1.25rem;
            font-weight: 700;
        }
        .custom-modal-body {
            position: relative;
            flex: 1 1 auto;
            padding: 1rem;
            overflow-y: auto;
        }
        .custom-modal-footer {
            display: flex;
            flex-wrap: wrap;
            flex-shrink: 0;
            align-items: center;
            justify-content: flex-end;
            padding: 0.75rem;
            border-top: 1px solid #dee2e6;
        }
        .custom-modal-footer .btn {
            margin: 0.25rem;
        }
        .custom-modal.loading {
            background: transparent;
            box-shadow: none;
        }

        /* Loading Spinner */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #4f46e5;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .live-badge {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

    </style>
</head>
<body>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Home View: Create or Join a Match -->
        <div id="homeView">
            <div class="card text-center shadow-lg">
                <div class="card-body p-lg-5 p-4">
                    <h1 class="card-title fw-bold display-4 mb-3">Cricket Score Counter</h1>
                    <p class="card-text text-muted fs-5 mb-4">The ultimate tool for your local cricket matches.</p>
                    <div class="d-grid gap-3 d-md-block">
                        <button class="btn btn-primary btn-lg px-5 py-3" onclick="showCustomModal('createMatchModal')">
                            <i class="bi bi-plus-circle-fill me-2"></i>Create New Match
                        </button>
                    </div>
                    <hr class="my-4">
                    <h2 class="fs-4 fw-semibold text-muted">Or Join an Existing Match</h2>
                    <div class="input-group mt-3 mx-auto" style="max-width: 400px;">
                        <input type="text" id="joinMatchIdInput" class="form-control form-control-lg" placeholder="Enter Match ID">
                        <button class="btn btn-outline-secondary" type="button" id="joinMatchBtn">
                            <i class="bi bi-arrow-right-circle-fill me-1"></i> Join
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scoreboard View -->
        <div id="scoreboardView">
            <!-- Match Info Header -->
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                 <h2 class="fw-bold mb-0 text-dark">Live Scoreboard</h2>
                 <div>
                    <span class="badge bg-danger rounded-pill me-2 live-badge">&nbsp;</span>
                    <span id="matchIdDisplay" class="match-id-display" title="Click to copy Match ID"></span>
                 </div>
            </div>
            
            <!-- Main Score Display -->
            <div class="card mb-4">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-5 text-center text-md-start">
                            <h3 id="battingTeamName" class="fw-bold fs-2"></h3>
                        </div>
                        <div class="col-md-2 text-center">
                            <h3 class="fw-bold fs-2 text-muted">VS</h3>
                             <div id="targetDisplay" class="fw-semibold text-danger" style="display:none;"></div>
                        </div>
                        <div class="col-md-5 text-center text-md-end">
                             <h3 id="bowlingTeamName" class="fw-bold fs-2"></h3>
                        </div>
                    </div>
                    <hr>
                    <div class="row align-items-center">
                         <div class="col-md-5 text-center">
                            <span id="scoreDisplay" class="score-display">0/0</span>
                            <div id="oversDisplay" class="overs-display">(0.0 Overs)</div>
                        </div>
                        <div class="col-md-2 d-none d-md-block"></div>
                        <div class="col-md-5 text-center">
                           <div class="mt-3 mt-md-0">
                               <h5 class="fw-bold">Current Players</h5>
                               <div id="strikerDisplay" class="player-info">Striker: - (0)</div>
                               <div id="nonStrikerDisplay" class="player-info">Non-Striker: - (0)</div>
                               <div id="bowlerDisplay" class="player-info mt-2">Bowler: - (0-0)</div>
                           </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scoring Controls -->
            <div class="card">
                 <div class="card-header text-center">Scoring Controls</div>
                 <div class="card-body text-center p-4 scoring-controls">
                    <h5 class="fw-semibold mb-3">Runs</h5>
                    <button class="btn btn-outline-success" onclick="handleScore(0)">0</button>
                    <button class="btn btn-success" onclick="handleScore(1)">1</button>
                    <button class="btn btn-success" onclick="handleScore(2)">2</button>
                    <button class="btn btn-success" onclick="handleScore(3)">3</button>
                    <button class="btn btn-primary" onclick="handleScore(4)">4</button>
                    <button class="btn btn-primary" onclick="handleScore(6)">6</button>
                    
                    <h5 class="fw-semibold mt-4 mb-3">Extras</h5>
                    <button class="btn btn-warning" onclick="handleExtra('wd')">Wide</button>
                    <button class="btn btn-warning" onclick="handleExtra('nb')">No Ball</button>
                    
                    <h5 class="fw-semibold mt-4 mb-3">Events</h5>
                    <button class="btn btn-danger" onclick="showWicketModal()">Wicket</button>
                    <button class="btn btn-secondary" onclick="swapBatsmen()">Swap Batsmen</button>
                    <hr class="my-4">
                    <button class="btn btn-info px-4" id="endInningsBtn" onclick="endInnings()">End Innings</button>
                 </div>
            </div>
        </div>

        <!-- Match End View -->
        <div id="matchEndView">
            <div class="card text-center">
                <div class="card-body p-lg-5 p-4">
                    <h1 class="display-4 fw-bold" id="matchResultText"></h1>
                    <p class="fs-5 text-muted" id="matchWinnerText"></p>
                    <hr>
                    <h3 class="fw-bold mt-4">Final Scorecards</h3>
                    <div id="finalScorecards" class="mt-3 text-start"></div>
                    <button class="btn btn-primary btn-lg mt-4" onclick="location.reload()">
                        <i class="bi bi-house-door-fill me-2"></i>Start New Match
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Create Match Modal -->
    <div id="createMatchModal" class="custom-modal-backdrop">
        <div class="custom-modal">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">Setup Your Match</h5>
                <button type="button" class="btn-close" onclick="hideCustomModal('createMatchModal')"></button>
            </div>
            <div class="custom-modal-body">
                <div class="mb-3">
                    <label for="teamANameInput" class="form-label">Team A Name</label>
                    <input type="text" class="form-control" id="teamANameInput" value="Team A">
                </div>
                <div class="mb-3">
                    <label for="teamBNameInput" class="form-label">Team B Name</label>
                    <input type="text" class="form-control" id="teamBNameInput" value="Team B">
                </div>
                <div class="mb-3">
                    <label for="oversInput" class="form-label">Total Overs per Inning</label>
                    <input type="number" class="form-control" id="oversInput" value="5">
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCustomModal('createMatchModal')">Close</button>
                <button type="button" class="btn btn-primary" id="startMatchBtn">Start Match</button>
            </div>
        </div>
    </div>
    
    <!-- Player Selection Modal -->
    <div id="playerSelectModal" class="custom-modal-backdrop">
        <div class="custom-modal">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title" id="playerSelectTitle">Select Players</h5>
            </div>
            <div class="custom-modal-body">
                <div id="initialPlayerSelect">
                    <div class="mb-3">
                        <label for="openingStrikerInput" class="form-label">Opening Batsman (Striker)</label>
                        <input type="text" class="form-control" id="openingStrikerInput" placeholder="Enter name">
                    </div>
                    <div class="mb-3">
                        <label for="openingNonStrikerInput" class="form-label">Opening Batsman (Non-Striker)</label>
                        <input type="text" class="form-control" id="openingNonStrikerInput" placeholder="Enter name">
                    </div>
                    <div class="mb-3">
                        <label for="openingBowlerInput" class="form-label">Opening Bowler</label>
                        <input type="text" class="form-control" id="openingBowlerInput" placeholder="Enter name">
                    </div>
                </div>
                <div id="newBatsmanSelect" style="display:none;">
                     <div class="mb-3">
                        <label for="newBatsmanInput" class="form-label">New Batsman's Name</label>
                        <input type="text" class="form-control" id="newBatsmanInput" placeholder="Enter name">
                    </div>
                </div>
                 <div id="newBowlerSelect" style="display:none;">
                     <div class="mb-3">
                        <label for="newBowlerInput" class="form-label">New Bowler's Name</label>
                        <input type="text" class="form-control" id="newBowlerInput" placeholder="Enter name">
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-primary" id="confirmPlayerSelectBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Wicket Details Modal -->
    <div id="wicketModal" class="custom-modal-backdrop">
        <div class="custom-modal">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">Wicket!</h5>
                <button type="button" class="btn-close" onclick="hideCustomModal('wicketModal')"></button>
            </div>
            <div class="custom-modal-body">
                <p>Which batsman is out?</p>
                <div class="form-check">
                   <input class="form-check-input" type="radio" name="outBatsmanRadio" id="outStrikerRadio" value="striker" checked>
                   <label class="form-check-label" for="outStrikerRadio" id="outStrikerLabel"></label>
                 </div>
                 <div class="form-check">
                   <input class="form-check-input" type="radio" name="outBatsmanRadio" id="outNonStrikerRadio" value="nonStriker">
                   <label class="form-check-label" for="outNonStrikerRadio" id="outNonStrikerLabel"></label>
                 </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCustomModal('wicketModal')">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmWicketBtn">Confirm Wicket</button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="custom-modal-backdrop">
        <div class="custom-modal loading">
            <div class="modal-body text-center">
                <div class="loader"></div>
                <p class="text-white fw-bold mt-3" id="loadingText">Loading...</p>
            </div>
        </div>
    </div>
    
    <!-- Firebase Libraries -->
    <script type="module">
        // Import Firebase modules. These are used to connect and interact with the database.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- VARIABLE DECLARATIONS ---
        
        // Use the user's provided Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDCISzlgdJ-QsjiFp6Q9JEoSJnunploiS0",
            authDomain: "g-cricket-1083d.firebaseapp.com",
            databaseURL: "https://g-cricket-1083d-default-rtdb.firebaseio.com",
            projectId: "g-cricket-1083d",
            storageBucket: "g-cricket-1083d.appspot.com", // Corrected storage bucket URL
            messagingSenderId: "136196175385",
            appId: "1:136196175385:web:91fff5cd387c7968e0dc88",
            measurementId: "G-6F9S4Z702R"
        };

        // Initialize Firebase app and services
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        // setLogLevel('debug'); // Uncomment for detailed logs

        let currentMatchId = null;
        let matchData = null; // This will hold the live data for the current match
        let unsubscribeFromMatch = null; // Function to stop listening for updates
        
        // --- CORE APPLICATION LOGIC ---
        window.onload = async () => {
            // Set up event listeners for buttons
            document.getElementById('startMatchBtn').addEventListener('click', createMatch);
            document.getElementById('joinMatchBtn').addEventListener('click', joinMatch);
            document.getElementById('confirmPlayerSelectBtn').addEventListener('click', handlePlayerSelection);
            document.getElementById('confirmWicketBtn').addEventListener('click', handleWicket);
            document.getElementById('matchIdDisplay').addEventListener('click', copyMatchId);
            
            try {
                await showCustomModal('loadingModal', 'Authenticating...');
                await signInAnonymously(auth);
                console.log("Authentication successful.");
            } catch (error) {
                console.error("Authentication failed:", error);
                alert("Could not connect to the service. Please refresh the page.");
            } finally {
                await hideCustomModal('loadingModal');
            }
        };

        /**
         * Creates a new match, saves it to Firestore, and transitions to the scoreboard.
         */
        async function createMatch() {
            const teamAName = document.getElementById('teamANameInput').value.trim() || 'Team A';
            const teamBName = document.getElementById('teamBNameInput').value.trim() || 'Team B';
            const oversPerInning = parseInt(document.getElementById('oversInput').value) || 5;

            await hideCustomModal('createMatchModal');
            await showCustomModal('loadingModal', 'Creating Match...');
            currentMatchId = generateMatchId();
            
            const newMatchData = {
                teamAName, teamBName, oversPerInning,
                gameState: 'setup', 
                tossWonBy: teamAName, 
                choseTo: 'Bat', 
                currentInning: 1,
                innings: {
                    1: createInningData(teamAName, teamBName),
                    2: createInningData(teamBName, teamAName),
                },
            };
            
            try {
                const matchRef = doc(db, `matches`, currentMatchId);
                await setDoc(matchRef, newMatchData);
                await listenToMatch(currentMatchId);
            } catch(error) {
                console.error("Error creating match:", error);
                alert("Failed to create match. Please try again.");
            } finally {
                await hideCustomModal('loadingModal');
            }
        }
        
        /**
         * Joins an existing match using the ID from the input field.
         */
        async function joinMatch() {
            const matchId = document.getElementById('joinMatchIdInput').value.trim();
            if (!matchId) return alert("Please enter a Match ID.");
            
            await showCustomModal('loadingModal', 'Joining Match...');
            try {
                const matchRef = doc(db, `matches`, matchId);
                const matchSnap = await getDoc(matchRef);
                if (matchSnap.exists()) {
                    await listenToMatch(matchId);
                } else {
                    alert("Match not found. Please check the ID.");
                }
            } catch (error) {
                console.error("Error joining match:", error);
                alert("An error occurred while trying to join the match.");
            } finally {
                await hideCustomModal('loadingModal');
            }
        }

        function listenToMatch(matchId) {
            currentMatchId = matchId;
            const matchRef = doc(db, `matches`, matchId);
            if (unsubscribeFromMatch) unsubscribeFromMatch();
            
            unsubscribeFromMatch = onSnapshot(matchRef, (doc) => {
                if (doc.exists()) {
                    matchData = doc.data();
                    renderUI();
                } else {
                    alert("The match has ended or been deleted.");
                    location.reload();
                }
            });
        }
        
        function renderUI() {
            if (!matchData) return;
            document.getElementById('homeView').style.display = 'none';
            document.getElementById('scoreboardView').style.display = 'none';
            document.getElementById('matchEndView').style.display = 'none';

            if (matchData.gameState === 'finished') {
                document.getElementById('matchEndView').style.display = 'block';
                renderMatchEndView();
            } else if (matchData.gameState === 'setup') {
                document.getElementById('homeView').style.display = 'block';
                const inningNumber = matchData.currentInning;
                const battingTeam = matchData.innings[inningNumber].battingTeam;
                
                showNewInningsModal(inningNumber, battingTeam);

            } else {
                document.getElementById('scoreboardView').style.display = 'block';
                renderScoreboard();
            }
        }
        
        function renderScoreboard() {
            const inning = matchData.innings[matchData.currentInning];
            if (!inning) return;

            const isSecondInning = matchData.currentInning === 2;
            const oversPerInning = matchData.oversPerInning;
            
            document.getElementById('battingTeamName').textContent = inning.battingTeam;
            document.getElementById('bowlingTeamName').textContent = inning.bowlingTeam;
            
            const { completedOvers, ballsInOver } = calculateOvers(inning.totalBalls);
            document.getElementById('scoreDisplay').textContent = `${inning.runs}/${inning.wickets}`;
            document.getElementById('oversDisplay').textContent = `(${completedOvers}.${ballsInOver} Overs)`;
            
            const striker = inning.striker || {};
            const nonStriker = inning.nonStriker || {};
            const bowler = inning.bowler || {};
            
            document.getElementById('strikerDisplay').textContent = `${striker.name || '...'}*: ${striker.runs || 0} (${striker.balls || 0})`;
            document.getElementById('nonStrikerDisplay').textContent = `${nonStriker.name || '...'}: ${nonStriker.runs || 0} (${nonStriker.balls || 0})`;
            const bowlerOvers = calculateOvers(bowler.balls || 0);
            document.getElementById('bowlerDisplay').textContent = `Bowler: ${bowler.name || '...'} (${bowlerOvers.completedOvers}.${bowlerOvers.ballsInOver} - ${bowler.runsConceded || 0} - ${bowler.wickets || 0})`;

            document.getElementById('matchIdDisplay').textContent = `ID: ${currentMatchId}`;
            
            const targetDisplay = document.getElementById('targetDisplay');
            if (isSecondInning) {
                const target = (matchData.innings['1'].runs || 0) + 1;
                const runsNeeded = target - inning.runs;
                const ballsRemaining = (oversPerInning * 6) - inning.totalBalls;
                targetDisplay.textContent = (runsNeeded > 0 && ballsRemaining > 0) ? `${inning.battingTeam} needs ${runsNeeded} runs in ${ballsRemaining} balls.` : `Target: ${target}`;
                targetDisplay.style.display = 'block';
            } else {
                targetDisplay.style.display = 'none';
            }
            
            // Corrected condition to check for end of innings
            if ((inning.wickets >= 10 || completedOvers >= oversPerInning) && (matchData.gameState === 'live' || matchData.gameState.includes('wait'))) {
                endInnings();
            }
        }
        
        function renderMatchEndView() {
            const { 1: inning1, 2: inning2 } = matchData.innings;
            let winner = inning1.battingTeam;
            let margin = `${inning1.runs - inning2.runs} runs`;

            if (inning2.runs > inning1.runs) {
                winner = inning2.battingTeam;
                margin = `${10 - inning2.wickets} wickets`;
            } else if (inning1.runs === inning2.runs) {
                winner = "Match Tied";
                margin = "";
            }
            document.getElementById('matchResultText').textContent = winner === "Match Tied" ? "Match Tied!" : `${winner} Won!`;
            document.getElementById('matchWinnerText').textContent = margin ? `Won by ${margin}` : "";
            document.getElementById('finalScorecards').innerHTML = `${createScorecardHTML(inning1)}${createScorecardHTML(inning2)}`;
        }

        // --- EVENT HANDLER FUNCTIONS ---
        
        async function handlePlayerSelection() {
            const inning = matchData.innings[matchData.currentInning];
            const inningPath = `innings.${matchData.currentInning}`;
            let updates = {};

            await hideCustomModal('playerSelectModal');

            if (matchData.gameState === 'setup') {
                const strikerName = document.getElementById('openingStrikerInput').value.trim() || 'Batsman 1';
                const nonStrikerName = document.getElementById('openingNonStrikerInput').value.trim() || 'Batsman 2';
                const bowlerName = document.getElementById('openingBowlerInput').value.trim() || 'Bowler 1';
                updates = {
                    gameState: 'live',
                    [`${inningPath}.striker`]: inning.battingStats[strikerName] || createPlayerData(strikerName),
                    [`${inningPath}.nonStriker`]: inning.battingStats[nonStrikerName] || createPlayerData(nonStrikerName),
                    [`${inningPath}.bowler`]: inning.bowlingStats[bowlerName] || createBowlerData(bowlerName),
                    [`${inningPath}.battingOrder`]: [...new Set([...inning.battingOrder, strikerName, nonStrikerName])],
                    [`${inningPath}.bowlersUsed`]: [...new Set([...inning.bowlersUsed, bowlerName])]
                };
            } else if (matchData.gameState === 'wicket_wait') {
                const newBatsmanName = document.getElementById('newBatsmanInput').value.trim();
                if (!newBatsmanName) return alert("Please enter the new batsman's name.");
                const newBatsmanData = inning.battingStats[newBatsmanName] || createPlayerData(newBatsmanName);
                updates = { gameState: 'live' };
                updates[`${inningPath}.${matchData.outBatsman}`] = newBatsmanData;
                updates[`${inningPath}.battingOrder`] = [...new Set([...inning.battingOrder, newBatsmanName])];
            } else if(matchData.gameState === 'over_end_wait') {
                const newBowlerName = document.getElementById('newBowlerInput').value.trim();
                if (!newBowlerName) return alert("Please enter the new bowler's name.");
                updates = { gameState: 'live' };
                updates[`${inningPath}.bowlingStats.${inning.bowler.name}`] = inning.bowler;
                updates[`${inningPath}.bowler`] = inning.bowlingStats[newBowlerName] || createBowlerData(newBowlerName);
                updates[`${inningPath}.bowlersUsed`] = [...new Set([...inning.bowlersUsed, newBowlerName])];
            }
             await updateMatchData(updates);
        }
        
        async function handleScore(runs) {
            if (matchData.gameState !== 'live') return;
            const inningPath = `innings.${matchData.currentInning}`;
            const inning = matchData.innings[matchData.currentInning];
            let updates = {};
            const newTotalRuns = inning.runs + runs;

            let tempStriker = { ...inning.striker, runs: inning.striker.runs + runs, balls: inning.striker.balls + 1 };
            let tempBowler = { ...inning.bowler, balls: inning.bowler.balls + 1, runsConceded: inning.bowler.runsConceded + runs };
            const endOfOver = (inning.totalBalls + 1) % 6 === 0;
            const rotateStrike = (runs % 2 !== 0 && !endOfOver) || (runs % 2 === 0 && endOfOver);

            updates = {
                [`${inningPath}.runs`]: newTotalRuns,
                [`${inningPath}.totalBalls`]: inning.totalBalls + 1,
                [`${inningPath}.bowler`]: tempBowler,
                [`${inningPath}.striker`]: rotateStrike ? inning.nonStriker : tempStriker,
                [`${inningPath}.nonStriker`]: rotateStrike ? tempStriker : inning.nonStriker
            };

            if (matchData.currentInning === 2 && newTotalRuns >= (matchData.innings['1'].runs + 1)) {
                await updateMatchData(updates);
                endInnings();
                return;
            }

            if (endOfOver && calculateOvers(inning.totalBalls + 1).completedOvers < matchData.oversPerInning) {
                updates['gameState'] = 'over_end_wait';
                await updateMatchData(updates);
                showNewBowlerModal();
            } else {
                 await updateMatchData(updates);
            }
        }
        
        async function handleExtra(type) {
            if (matchData.gameState !== 'live') return;
            const inningPath = `innings.${matchData.currentInning}`;
            const inning = matchData.innings[matchData.currentInning];
            const newTotalRuns = inning.runs + 1;

            const updates = {
                [`${inningPath}.runs`]: newTotalRuns,
                [`${inningPath}.bowler.runsConceded`]: inning.bowler.runsConceded + 1
            };
            
            if (matchData.currentInning === 2 && newTotalRuns >= (matchData.innings['1'].runs + 1)) {
                await updateMatchData(updates);
                endInnings();
                return;
            }
            await updateMatchData(updates);
        }

        async function handleWicket() {
            if (matchData.gameState !== 'live') return;
            
            const outBatsman = document.querySelector('input[name="outBatsmanRadio"]:checked').value;
            const inningPath = `innings.${matchData.currentInning}`;
            const inning = matchData.innings[matchData.currentInning];
            
            const outBatsmanData = { ...inning[outBatsman], isOut: true };
            const updates = {
                [`${inningPath}.wickets`]: inning.wickets + 1,
                [`${inningPath}.totalBalls`]: inning.totalBalls + 1,
                [`${inningPath}.bowler.balls`]: inning.bowler.balls + 1,
                [`${inningPath}.bowler.wickets`]: inning.bowler.wickets + 1,
                [`${inningPath}.battingStats.${outBatsmanData.name}`]: outBatsmanData,
                gameState: 'wicket_wait',
                outBatsman
            };
            
            await hideCustomModal('wicketModal');
            await updateMatchData(updates);

            if (inning.wickets + 1 >= 10) {
                 endInnings();
            } else {
                showNewBatsmanModal();
            }
        }
        
        async function endInnings() {
            const inningPath = `innings.${matchData.currentInning}`;
            const inning = matchData.innings[matchData.currentInning];
            const updates = {};
            if(inning.striker.name) updates[`${inningPath}.battingStats.${inning.striker.name}`] = inning.striker;
            if(inning.nonStriker.name) updates[`${inningPath}.battingStats.${inning.nonStriker.name}`] = inning.nonStriker;
            if(inning.bowler.name) updates[`${inningPath}.bowlingStats.${inning.bowler.name}`] = inning.bowler;

            if (matchData.currentInning === 1) {
                updates.currentInning = 2;
                updates.gameState = 'setup';
            } else {
                updates.gameState = 'finished';
            }
            await updateMatchData(updates);
        }
        
        async function swapBatsmen() {
            if (matchData.gameState !== 'live') return;
            const inningPath = `innings.${matchData.currentInning}`;
            const inning = matchData.innings[matchData.currentInning];
            await updateMatchData({
                [`${inningPath}.striker`]: inning.nonStriker,
                [`${inningPath}.nonStriker`]: inning.striker
            });
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        
        function createInningData(battingTeam, bowlingTeam) {
            return { battingTeam, bowlingTeam, runs: 0, wickets: 0, totalBalls: 0, striker: {}, nonStriker: {}, bowler: {}, battingStats: {}, bowlingStats: {}, battingOrder: [], bowlersUsed: [] };
        }
        function createPlayerData(name) { return { name, runs: 0, balls: 0, isOut: false }; }
        function createBowlerData(name) { return { name, balls: 0, runsConceded: 0, wickets: 0 }; }

        async function updateMatchData(updates) {
            if (!currentMatchId) return;
            await showCustomModal('loadingModal', 'Updating...');
            try {
                const matchRef = doc(db, "matches", currentMatchId);
                await updateDoc(matchRef, updates);
            } catch (error) {
                console.error("Failed to update match data:", error);
            } finally {
                await hideCustomModal('loadingModal');
            }
        }
        
        function calculateOvers(balls) {
            if (typeof balls !== 'number' || balls < 0) return { completedOvers: 0, ballsInOver: 0};
            return { completedOvers: Math.floor(balls / 6), ballsInOver: balls % 6 };
        }
        function generateMatchId() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }
        
        function copyMatchId() {
            if (!currentMatchId) return;
            const textArea = document.createElement("textarea");
            textArea.value = currentMatchId;
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.select();
            let success = false;
            try { success = document.execCommand('copy'); } catch (err) { console.error('Copy failed', err); }
            document.body.removeChild(textArea);
            const display = document.getElementById('matchIdDisplay');
            const originalText = display.textContent;
            display.textContent = success ? "Copied!" : "Copy Failed!";
            setTimeout(() => { if (display.textContent !== originalText) display.textContent = originalText; }, 1500);
        }

        function showWicketModal() {
            document.getElementById('outStrikerLabel').textContent = document.getElementById('strikerDisplay').textContent;
            document.getElementById('outNonStrikerLabel').textContent = document.getElementById('nonStrikerDisplay').textContent;
            showCustomModal('wicketModal');
        }
        function showNewBatsmanModal() {
            document.getElementById('initialPlayerSelect').style.display = 'none';
            document.getElementById('newBatsmanSelect').style.display = 'block';
            document.getElementById('newBowlerSelect').style.display = 'none';
            document.getElementById('newBatsmanInput').value = '';
            document.getElementById('playerSelectTitle').textContent = `Wicket! Who is the next batsman?`;
            showCustomModal('playerSelectModal');
        }
         function showNewBowlerModal() {
            document.getElementById('initialPlayerSelect').style.display = 'none';
            document.getElementById('newBatsmanSelect').style.display = 'none';
            document.getElementById('newBowlerSelect').style.display = 'block';
            document.getElementById('newBowlerInput').value = '';
            document.getElementById('playerSelectTitle').textContent = `End of Over. Select New Bowler.`;
            showCustomModal('playerSelectModal');
        }
        function showNewInningsModal(inningNumber, battingTeam) {
            document.getElementById('initialPlayerSelect').style.display = 'block';
            document.getElementById('newBatsmanSelect').style.display = 'none';
            document.getElementById('newBowlerSelect').style.display = 'none';
            document.getElementById('openingStrikerInput').value = '';
            document.getElementById('openingNonStrikerInput').value = '';
            document.getElementById('openingBowlerInput').value = '';
            document.getElementById('playerSelectTitle').textContent = `Start Inning ${inningNumber}: ${battingTeam}`;
            showCustomModal('playerSelectModal');
        }
        
        // --- Custom Modal Functions ---
        function showCustomModal(modalId, text) {
            const modal = document.getElementById(modalId);
            if (text) document.getElementById('loadingText').textContent = text;
            if (modal) modal.style.display = 'flex';
        }
        function hideCustomModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }
        
        function createScorecardHTML(inningData) {
            if (!inningData || !inningData.battingOrder) return '';
            let battingRows = '';
            const processedBatsmen = new Set();
            for (const playerName of inningData.battingOrder) {
                if (processedBatsmen.has(playerName) || !playerName) continue;
                let stats = inningData.battingStats[playerName] || (inningData.striker.name === playerName ? inningData.striker : inningData.nonStriker);
                if (stats && stats.name) {
                    battingRows += `<tr><td>${stats.name}</td><td>${stats.isOut ? 'out' : 'not out'}</td><td class="fw-bold">${stats.runs}</td><td>${stats.balls}</td></tr>`;
                    processedBatsmen.add(playerName);
                }
            }
            let bowlingRows = '';
            const processedBowlers = new Set();
            for (const bowlerName of inningData.bowlersUsed) {
                if (processedBowlers.has(bowlerName) || !bowlerName) continue;
                let stats = inningData.bowlingStats[bowlerName] || (inningData.bowler.name === bowlerName ? inningData.bowler : null);
                 if (stats && stats.name) {
                    const { completedOvers, ballsInOver } = calculateOvers(stats.balls);
                    bowlingRows += `<tr><td>${stats.name}</td><td>${completedOvers}.${ballsInOver}</td><td>${stats.runsConceded}</td><td class="fw-bold">${stats.wickets}</td></tr>`;
                    processedBowlers.add(bowlerName);
                 }
            }
            const { completedOvers, ballsInOver } = calculateOvers(inningData.totalBalls);
            return `<div class="card mb-3"><div class="card-header bg-light text-dark fw-bold">${inningData.battingTeam} - ${inningData.runs}/${inningData.wickets} (${completedOvers}.${ballsInOver} Overs)</div><div class="card-body"><h6 class="fw-bold">Batting</h6><div class="table-responsive"><table class="table table-sm mb-0"><thead><tr><th>Batsman</th><th>Status</th><th>Runs</th><th>Balls</th></tr></thead><tbody>${battingRows}</tbody></table></div><h6 class="fw-bold mt-3">Bowling</h6><div class="table-responsive"><table class="table table-sm mb-0"><thead><tr><th>Bowler</th><th>Overs</th><th>Runs</th><th>Wickets</th></tr></thead><tbody>${bowlingRows}</tbody></table></div></div></div>`;
        }

        // --- Expose functions to global scope for HTML onclick attributes ---
        window.handleScore = handleScore;
        window.handleExtra = handleExtra;
        window.swapBatsmen = swapBatsmen;
        window.endInnings = endInnings;
        window.showCustomModal = showCustomModal;
        window.hideCustomModal = hideCustomModal;
        window.showWicketModal = showWicketModal;

    </script>
</body>
</html>
