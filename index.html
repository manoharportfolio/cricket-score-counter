<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricket Score Counter</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* Custom styles for a more advanced UI */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            padding-top: 70px; /* Space for fixed navbar */
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }

        .main-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 1rem;
        }

        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
            overflow: hidden; /* Ensures content respects border-radius */
            transition: all 0.3s ease;
        }

        .card-header {
            background: linear-gradient(135deg, #4f46e5, #818cf8);
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
            border-bottom: 0;
            padding: 1.5rem;
        }

        .btn-primary {
            background-color: #4f46e5;
            border-color: #4f46e5;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background-color: #4338ca;
            border-color: #4338ca;
            transform: translateY(-2px);
        }
        
        .score-display {
            font-size: 4rem;
            font-weight: 900;
            color: #1e293b;
        }

        .overs-display {
            font-size: 1.5rem;
            color: #64748b;
            font-weight: 600;
        }

        .scoring-controls .btn {
            font-size: 1.2rem;
            font-weight: 700;
            padding: 1rem;
            margin: 0.25rem;
            border-radius: 0.75rem;
        }

        .player-info {
            font-size: 1.1rem;
        }

        .match-id-display {
            background-color: #eef2ff;
            color: #4338ca;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .match-id-display:hover {
            background-color: #e0e7ff;
        }

        #authView, #homeView, #scoreboardView, #matchEndView, #myMatchesView, #playersView, #scoringControls { display: none; }
        
        /* --- Custom Modal Styles --- */
        .custom-modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1050; /* Higher z-index for modals */
            align-items: center;
            justify-content: center;
        }
        .custom-modal {
            width: 90%;
            max-width: 500px;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        .custom-modal-header {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .custom-modal-title {
            margin-bottom: 0;
            font-size: 1.25rem;
            font-weight: 700;
        }
        .custom-modal-body {
            position: relative;
            flex: 1 1 auto;
            padding: 1rem;
            overflow-y: auto;
        }
        .custom-modal-footer {
            display: flex;
            flex-wrap: wrap;
            flex-shrink: 0;
            align-items: center;
            justify-content: flex-end;
            padding: 0.75rem;
            border-top: 1px solid #dee2e6;
        }
        .custom-modal-footer .btn {
            margin: 0.25rem;
        }
        .custom-modal.loading {
            background: transparent;
            box-shadow: none;
        }

        /* Loading Spinner */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #4f46e5;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .live-badge {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

    </style>
</head>
<body>
    
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg fixed-top shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#" onclick="goToHome()">
            <i class="bi bi-person-workspace"></i>
            Cricket Score Counter
        </a>
        <div class="d-flex">
             <button id="myMatchesBtn" class="btn btn-outline-primary me-2" style="display: none;">My Matches</button>
             <button id="playersBtn" class="btn btn-outline-info me-2" style="display: none;">Players</button>
            <button id="profileBtn" class="btn btn-outline-secondary me-2" style="display: none;">My Profile</button>
            <button id="logoutBtn" class="btn btn-outline-danger" style="display: none;">Logout</button>
        </div>
      </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">

        <!-- Authentication View -->
        <div id="authView">
             <div class="card text-center shadow-lg">
                <div class="card-body p-lg-5 p-4">
                    <h1 class="card-title fw-bold display-5 mb-3">Welcome</h1>
                    <p class="text-muted mb-4">Please sign in or register to continue.</p>
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                             <div class="mb-3">
                                <input type="email" id="emailInput" class="form-control form-control-lg" placeholder="Email">
                            </div>
                            <div class="mb-3">
                                <input type="password" id="passwordInput" class="form-control form-control-lg" placeholder="Password">
                            </div>
                            <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                                <button id="loginBtn" class="btn btn-primary btn-lg">Login</button>
                                <button id="registerBtn" class="btn btn-outline-secondary btn-lg">Register</button>
                            </div>
                             <div class="mt-3">
                                <a href="#" id="forgotPasswordLink" class="text-decoration-none">Forgot Password?</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Home View: Create or Join a Match -->
        <div id="homeView">
            <div class="card text-center shadow-lg">
                <div class="card-body p-lg-5 p-4">
                    <h1 class="card-title fw-bold display-4 mb-3">Start a Match</h1>
                    <p class="card-text text-muted fs-5 mb-4">Create a new match or join one that's already in progress.</p>
                    <div class="d-grid gap-3 d-md-block">
                        <button class="btn btn-primary btn-lg px-5 py-3" onclick="showCustomModal('createMatchModal')">
                            <i class="bi bi-plus-circle-fill me-2"></i>Create New Match
                        </button>
                    </div>
                    <hr class="my-4">
                    <h2 class="fs-4 fw-semibold text-muted">Or Join an Existing Match</h2>
                    <div class="input-group mt-3 mx-auto" style="max-width: 400px;">
                        <input type="text" id="joinMatchIdInput" class="form-control form-control-lg" placeholder="Enter Match ID">
                        <button class="btn btn-outline-secondary" type="button" id="joinMatchBtn">
                            <i class="bi bi-arrow-right-circle-fill me-1"></i> Join
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Matches View -->
        <div id="myMatchesView">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="fw-bold mb-0">My Matches</h2>
            </div>
            <div id="myMatchesList" class="list-group">
                <!-- Match list will be populated here -->
            </div>
        </div>

        <!-- Players and Teams View -->
        <div id="playersView">
             <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="fw-bold mb-0">Manage Teams & Players</h2>
                <button class="btn btn-primary" onclick="showCustomModal('addTeamModal')"><i class="bi bi-plus-circle"></i> Add Team</button>
            </div>
            <div id="teamsContainer" class="accordion">
                <!-- Teams and players will be populated here -->
            </div>
        </div>

        <!-- Scoreboard View -->
        <div id="scoreboardView">
            <!-- Match Info Header -->
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                 <h2 class="fw-bold mb-0 text-dark">Live Scoreboard</h2>
                 <div>
                    <span class="badge bg-danger rounded-pill me-2 live-badge">&nbsp;</span>
                    <span id="matchIdDisplay" class="match-id-display" title="Click to copy Match ID"></span>
                 </div>
            </div>
            
            <!-- Main Score Display -->
            <div class="card mb-4">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-5 text-center text-md-start">
                            <h3 id="battingTeamName" class="fw-bold fs-2"></h3>
                        </div>
                        <div class="col-md-2 text-center">
                            <h3 class="fw-bold fs-2 text-muted">VS</h3>
                             <div id="targetDisplay" class="fw-semibold text-danger" style="display:none;"></div>
                        </div>
                        <div class="col-md-5 text-center text-md-end">
                             <h3 id="bowlingTeamName" class="fw-bold fs-2"></h3>
                        </div>
                    </div>
                    <hr>
                    <div class="row align-items-center">
                         <div class="col-md-5 text-center">
                            <span id="scoreDisplay" class="score-display">0/0</span>
                            <div id="oversDisplay" class="overs-display">(0.0 Overs)</div>
                        </div>
                        <div class="col-md-2 d-none d-md-block"></div>
                        <div class="col-md-5 text-center">
                           <div class="mt-3 mt-md-0">
                               <h5 class="fw-bold">Current Players</h5>
                               <div id="strikerDisplay" class="player-info">Striker: - (0)</div>
                               <div id="nonStrikerDisplay" class="player-info">Non-Striker: - (0)</div>
                               <div id="bowlerDisplay" class="player-info mt-2">Bowler: - (0-0)</div>
                           </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scoring Controls -->
            <div id="scoringControls" class="card mb-4">
                 <div class="card-header text-center">Scoring Controls</div>
                 <div class="card-body text-center p-4 scoring-controls">
                    <h5 class="fw-semibold mb-3">Runs</h5>
                    <button class="btn btn-outline-success" onclick="handleScore(0)">0</button>
                    <button class="btn btn-success" onclick="handleScore(1)">1</button>
                    <button class="btn btn-success" onclick="handleScore(2)">2</button>
                    <button class="btn btn-success" onclick="handleScore(3)">3</button>
                    <button class="btn btn-primary" onclick="handleScore(4)">4</button>
                    <button class="btn btn-primary" onclick="handleScore(6)">6</button>
                    
                    <h5 class="fw-semibold mt-4 mb-3">Extras</h5>
                    <button class="btn btn-warning" onclick="showExtraModal('wd')">Wide</button>
                    <button class="btn btn-warning" onclick="showExtraModal('nb')">No Ball</button>
                    <button class="btn btn-info" onclick="showExtraModal('b')">Byes</button>
                    <button class="btn btn-info" onclick="showExtraModal('lb')">Leg Byes</button>
                    
                    <h5 class="fw-semibold mt-4 mb-3">Events</h5>
                    <button class="btn btn-danger" onclick="showWicketModal()">Wicket</button>
                    <button class="btn btn-secondary" onclick="swapBatsmen()">Swap Batsmen</button>
                    <button class="btn btn-warning" onclick="handleUndo()">Undo</button>
                    <hr class="my-4">
                    <button class="btn btn-info px-4" id="endInningsBtn" onclick="endInnings()">End Innings</button>
                 </div>
            </div>

            <!-- Live Scorecards -->
            <h3 class="fw-bold text-dark mt-4 mb-3">Live Scorecards</h3>
            <div id="liveScorecardInning1"></div>
            <div id="liveScorecardInning2" style="display:none;"></div>
        </div>

        <!-- Match End View -->
        <div id="matchEndView">
            <div class="card text-center">
                <div class="card-body p-lg-5 p-4">
                    <h1 class="display-4 fw-bold" id="matchResultText"></h1>
                    <p class="fs-5 text-muted" id="matchWinnerText"></p>
                    <hr>
                    <h3 class="fw-bold mt-4">Final Scorecards</h3>
                    <div id="finalScorecards" class="mt-3 text-start"></div>
                    <button class="btn btn-primary btn-lg mt-4" onclick="goToHome()">
                        <i class="bi bi-house-door-fill me-2"></i>Back to Dashboard
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Create Match Modal -->
    <div id="createMatchModal" class="custom-modal-backdrop">
        <div class="custom-modal">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">Setup Your Match</h5>
                <button type="button" class="btn-close" onclick="hideCustomModal('createMatchModal')"></button>
            </div>
            <div class="custom-modal-body">
                <div class="mb-3">
                    <label class="form-label">Team A</label>
                    <select id="teamASelect" class="form-select"></select>
                    <input type="text" id="teamANameInput" class="form-control mt-2" placeholder="Or enter custom name">
                </div>
                <div class="mb-3">
                    <label class="form-label">Team B</label>
                    <select id="teamBSelect" class="form-select"></select>
                    <input type="text" id="teamBNameInput" class="form-control mt-2" placeholder="Or enter custom name">
                </div>
                <div class="mb-3">
                    <label for="oversInput" class="form-label">Total Overs per Inning</label>
                    <input type="number" class="form-control" id="oversInput" value="5">
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCustomModal('createMatchModal')">Close</button>
                <button type="button" class="btn btn-primary" id="startMatchBtn">Start Match</button>
            </div>
        </div>
    </div>
    
    <!-- Player Selection Modal -->
    <div id="playerSelectModal" class="custom-modal-backdrop">
        <div class="custom-modal">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title" id="playerSelectTitle">Select Players</h5>
            </div>
            <div class="custom-modal-body">
                <div id="initialPlayerSelect">
                    <!-- Dynamic fields will be added here by JS -->
                </div>
                <div id="newBatsmanSelect" style="display:none;">
                     <!-- Dynamic fields will be added here by JS -->
                </div>
                 <div id="newBowlerSelect" style="display:none;">
                     <!-- Dynamic fields will be added here by JS -->
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-primary" id="confirmPlayerSelectBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Wicket Details Modal -->
    <div id="wicketModal" class="custom-modal-backdrop">
        <div class="custom-modal">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">Wicket!</h5>
                <button type="button" class="btn-close" onclick="hideCustomModal('wicketModal')"></button>
            </div>
            <div class="custom-modal-body">
                <p>Which batsman is out?</p>
                <div class="form-check">
                   <input class="form-check-input" type="radio" name="outBatsmanRadio" id="outStrikerRadio" value="striker" checked>
                   <label class="form-check-label" for="outStrikerRadio" id="outStrikerLabel"></label>
                 </div>
                 <div class="form-check">
                   <input class="form-check-input" type="radio" name="outBatsmanRadio" id="outNonStrikerRadio" value="nonStriker">
                   <label class="form-check-label" for="outNonStrikerRadio" id="outNonStrikerLabel"></label>
                 </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCustomModal('wicketModal')">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmWicketBtn">Confirm Wicket</button>
            </div>
        </div>
    </div>
    
    <!-- Extras Modal -->
    <div id="extraModal" class="custom-modal-backdrop">
        <div class="custom-modal">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title" id="extraModalTitle"></h5>
                <button type="button" class="btn-close" onclick="hideCustomModal('extraModal')"></button>
            </div>
            <div class="custom-modal-body">
                <label for="extraRunsInput" class="form-label">Runs scored in addition to the penalty?</label>
                <input type="number" id="extraRunsInput" class="form-control" value="0" min="0">
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCustomModal('extraModal')">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmExtraBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="custom-modal-backdrop">
        <div class="custom-modal">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">My Profile</h5>
                <button type="button" class="btn-close" onclick="hideCustomModal('profileModal')"></button>
            </div>
            <div class="custom-modal-body">
                <p><strong>Email:</strong> <span id="profileEmail"></span></p>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCustomModal('profileModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Add Team Modal -->
    <div id="addTeamModal" class="custom-modal-backdrop">
        <div class="custom-modal">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">Add New Team</h5>
                <button type="button" class="btn-close" onclick="hideCustomModal('addTeamModal')"></button>
            </div>
            <div class="custom-modal-body">
                <div class="mb-3">
                    <label for="newTeamNameInput" class="form-label">Team Name</label>
                    <input type="text" class="form-control" id="newTeamNameInput" placeholder="e.g., Local Warriors">
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCustomModal('addTeamModal')">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTeamBtn">Save Team</button>
            </div>
        </div>
    </div>


    <!-- Loading Modal -->
    <div id="loadingModal" class="custom-modal-backdrop">
        <div class="custom-modal loading">
            <div class="modal-body text-center">
                <div class="loader"></div>
                <p class="text-white fw-bold mt-3" id="loadingText">Loading...</p>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection, query, where, getDocs, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- VARIABLE DECLARATIONS ---
        const firebaseConfig = {
            apiKey: "AIzaSyDCISzlgdJ-QsjiFp6Q9JEoSJnunploiS0",
            authDomain: "g-cricket-1083d.firebaseapp.com",
            databaseURL: "https://g-cricket-1083d-default-rtdb.firebaseio.com",
            projectId: "g-cricket-1083d",
            storageBucket: "g-cricket-1083d.appspot.com",
            messagingSenderId: "136196175385",
            appId: "1:136196175385:web:91fff5cd387c7968e0dc88",
            measurementId: "G-6F9S4Z702R"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        // setLogLevel('debug');

        let currentMatchId = null;
        let matchData = null;
        let unsubscribeFromMatch = null;
        let matchHistory = [];
        let userTeams = [];
        
        // --- CORE APPLICATION LOGIC ---
        window.onload = () => {
            // All event listeners are attached here
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('forgotPasswordLink').addEventListener('click', handleForgotPassword);
            document.getElementById('profileBtn').addEventListener('click', showProfileModal);
            document.getElementById('myMatchesBtn').addEventListener('click', handleMyMatchesClick);
            document.getElementById('playersBtn').addEventListener('click', handlePlayersClick);
            document.getElementById('startMatchBtn').addEventListener('click', createMatch);
            document.getElementById('joinMatchBtn').addEventListener('click', joinMatch);
            document.getElementById('confirmPlayerSelectBtn').addEventListener('click', handlePlayerSelection);
            document.getElementById('confirmWicketBtn').addEventListener('click', handleWicket);
            document.getElementById('matchIdDisplay').addEventListener('click', copyMatchId);
            document.getElementById('saveTeamBtn').addEventListener('click', handleSaveTeam);

            onAuthStateChanged(auth, user => {
                if (user) {
                    fetchUserTeams();
                    if(!currentMatchId) showView('homeView');
                } else {
                    showView('authView');
                    if (unsubscribeFromMatch) unsubscribeFromMatch();
                    currentMatchId = null;
                    matchData = null;
                    matchHistory = [];
                }
            });
        };

        // --- AUTHENTICATION ---
        async function handleLogin() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            if (!email || !password) return alert("Email and password are required.");
            await showCustomModal('loadingModal', 'Logging in...');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert(`Login Failed: ${error.message}`);
            } finally {
                await hideCustomModal('loadingModal');
            }
        }

        async function handleRegister() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
             if (!email || !password) return alert("Email and password are required.");
            await showCustomModal('loadingModal', 'Registering...');
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                 alert(`Registration Failed: ${error.message}`);
            } finally {
                await hideCustomModal('loadingModal');
            }
        }
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed:", error);
            }
        }

        async function handleForgotPassword(e) {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            if(!email) return alert("Please enter your email address to reset your password.");
            await showCustomModal('loadingModal', 'Sending reset link...');
            try {
                await sendPasswordResetEmail(auth, email);
                alert("Password reset email sent! Please check your inbox.");
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                await hideCustomModal('loadingModal');
            }
        }
        
        function showProfileModal() {
            const user = auth.currentUser;
            if(user) {
                document.getElementById('profileEmail').textContent = user.email;
                showCustomModal('profileModal');
            }
        }

        // --- TEAMS & PLAYERS MANAGEMENT ---
        
        async function fetchUserTeams() {
            if (!auth.currentUser) return;
            const teamsRef = collection(db, `users/${auth.currentUser.uid}/teams`);
            const querySnapshot = await getDocs(teamsRef);
            userTeams = [];
            querySnapshot.forEach(doc => {
                userTeams.push({ id: doc.id, ...doc.data() });
            });
            populateTeamSelectors();
        }

        function populateTeamSelectors() {
            const teamASelect = document.getElementById('teamASelect');
            const teamBSelect = document.getElementById('teamBSelect');
            teamASelect.innerHTML = '<option value="">Select a team or enter custom name</option>';
            teamBSelect.innerHTML = '<option value="">Select a team or enter custom name</option>';
            userTeams.forEach(team => {
                teamASelect.innerHTML += `<option value="${team.name}">${team.name}</option>`;
                teamBSelect.innerHTML += `<option value="${team.name}">${team.name}</option>`;
            });
        }

        async function handlePlayersClick() {
            showView('playersView');
            await showCustomModal('loadingModal', 'Loading teams...');
            await fetchUserTeams();
            renderTeamsList();
            await hideCustomModal('loadingModal');
        }
        
        async function handleSaveTeam() {
            const teamName = document.getElementById('newTeamNameInput').value.trim();
            if(!teamName) return alert("Team name cannot be empty.");
            
            await hideCustomModal('addTeamModal');
            await showCustomModal('loadingModal', 'Saving team...');

            const teamData = { name: teamName, players: [] };
            const teamsRef = collection(db, `users/${auth.currentUser.uid}/teams`);
            await setDoc(doc(teamsRef, teamName), teamData); // Use team name as ID for simplicity
            
            await fetchUserTeams();
            renderTeamsList();
            await hideCustomModal('loadingModal');
            document.getElementById('newTeamNameInput').value = '';
        }

        function renderTeamsList() {
            const container = document.getElementById('teamsContainer');
            container.innerHTML = '';
            if (userTeams.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No teams created yet. Add a team to get started.</p>';
                return;
            }

            userTeams.forEach((team, index) => {
                let playersList = '';
                team.players.forEach(player => {
                    playersList += `<li class="list-group-item d-flex justify-content-between align-items-center">${player} <button class="btn btn-sm btn-outline-danger" onclick="deletePlayer('${team.id}', '${player}')"><i class="bi bi-x-lg"></i></button></li>`;
                });

                container.innerHTML += `
                    <div class="accordion-item">
                        <h2 class="accordion-header d-flex justify-content-between align-items-center" id="heading${index}">
                             <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                ${team.name}
                            </button>
                             <button class="btn btn-sm btn-outline-danger me-2" onclick="handleDeleteTeam('${team.id}')"><i class="bi bi-trash"></i></button>
                        </h2>
                        <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#teamsContainer">
                            <div class="accordion-body">
                                <ul class="list-group mb-3">${playersList}</ul>
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="New player name" id="player-input-${team.id}">
                                    <button class="btn btn-outline-success" onclick="addPlayer('${team.id}')">Add Player</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        async function addPlayer(teamId) {
            const input = document.getElementById(`player-input-${teamId}`);
            const playerName = input.value.trim();
            if(!playerName) return;

            const team = userTeams.find(t => t.id === teamId);
            if(team && !team.players.includes(playerName)) {
                const updatedPlayers = [...team.players, playerName];
                const teamRef = doc(db, `users/${auth.currentUser.uid}/teams`, teamId);
                await updateDoc(teamRef, { players: updatedPlayers });
                await fetchUserTeams();
                renderTeamsList();
            }
            input.value = '';
        }

        async function deletePlayer(teamId, playerName) {
            const team = userTeams.find(t => t.id === teamId);
             if(team) {
                const updatedPlayers = team.players.filter(p => p !== playerName);
                const teamRef = doc(db, `users/${auth.currentUser.uid}/teams`, teamId);
                await updateDoc(teamRef, { players: updatedPlayers });
                await fetchUserTeams();
                renderTeamsList();
            }
        }
        
        async function handleDeleteTeam(teamId) {
            if(!confirm(`Are you sure you want to delete the team "${teamId}"? This cannot be undone.`)) return;
            await showCustomModal('loadingModal', 'Deleting team...');
            const teamRef = doc(db, `users/${auth.currentUser.uid}/teams`, teamId);
            await deleteDoc(teamRef);
            await fetchUserTeams();
            renderTeamsList();
            await hideCustomModal('loadingModal');
        }

        // --- MATCH MANAGEMENT ---
        async function createMatch() {
            const teamA = document.getElementById('teamASelect').value || document.getElementById('teamANameInput').value.trim() || 'Team A';
            const teamB = document.getElementById('teamBSelect').value || document.getElementById('teamBNameInput').value.trim() || 'Team B';
            const oversPerInning = parseInt(document.getElementById('oversInput').value) || 5;

            if (teamA === teamB) return alert("Teams must have different names.");

            await hideCustomModal('createMatchModal');
            await showCustomModal('loadingModal', 'Creating Match...');
            currentMatchId = generateMatchId();
            matchHistory = []; 
            
            const newMatchData = {
                creatorUid: auth.currentUser.uid, 
                teamAName: teamA, teamBName: teamB, oversPerInning,
                isTeamApremade: !!document.getElementById('teamASelect').value,
                isTeamBpremade: !!document.getElementById('teamBSelect').value,
                gameState: 'setup', 
                currentInning: 1,
                innings: { 1: createInningData(teamA, teamB), 2: createInningData(teamB, teamA) },
            };
            
            try {
                const matchRef = doc(db, `matches`, currentMatchId);
                await setDoc(matchRef, newMatchData);
                await listenToMatch(currentMatchId);
            } catch(error) {
                console.error("Error creating match:", error);
            } finally {
                await hideCustomModal('loadingModal');
            }
        }
        
        async function joinMatch() {
            const matchId = document.getElementById('joinMatchIdInput').value.trim();
            if (!matchId) return alert("Please enter a Match ID.");
            await showCustomModal('loadingModal', 'Joining Match...');
            matchHistory = [];
            try {
                const matchRef = doc(db, `matches`, matchId);
                const matchSnap = await getDoc(matchRef);
                if (matchSnap.exists()) {
                    await listenToMatch(matchId);
                } else {
                    alert("Match not found.");
                }
            } catch (error) {
                console.error("Error joining match:", error);
            } finally {
                await hideCustomModal('loadingModal');
            }
        }

        async function handleMyMatchesClick() {
            const user = auth.currentUser;
            if (!user) return;

            await showCustomModal('loadingModal', 'Fetching your matches...');
            showView('myMatchesView');
            const matchesRef = collection(db, "matches");
            const q = query(matchesRef, where("creatorUid", "==", user.uid));
            const querySnapshot = await getDocs(q);
            
            const listContainer = document.getElementById('myMatchesList');
            listContainer.innerHTML = ''; // Clear previous list

            if (querySnapshot.empty) {
                listContainer.innerHTML = '<p class="text-center text-muted">You have not created any matches yet.</p>';
            } else {
                querySnapshot.forEach((doc) => {
                    const match = doc.data();
                    const status = match.gameState === 'finished' ? 'Completed' : 'Pending';
                    const statusColor = status === 'Completed' ? 'success' : 'warning';

                    const listItem = document.createElement('div');
                    listItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.style.cursor = 'pointer';
                    infoDiv.innerHTML = `
                        <h5 class="mb-1">${match.teamAName} vs ${match.teamBName}</h5>
                        <small>Match ID: ${doc.id}</small>
                    `;
                    infoDiv.addEventListener('click', () => listenToMatch(doc.id));

                    const controlsDiv = document.createElement('div');
                    controlsDiv.innerHTML = `
                        <span class="badge bg-${statusColor} rounded-pill me-2">${status}</span>
                        <button class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                    controlsDiv.querySelector('button').addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleDeleteMatch(doc.id);
                    });

                    listItem.appendChild(infoDiv);
                    listItem.appendChild(controlsDiv);
                    listContainer.appendChild(listItem);
                });
            }
             await hideCustomModal('loadingModal');
        }

        async function handleDeleteMatch(matchIdToDelete) {
            if (!matchIdToDelete) return;

            const confirmation = confirm("Are you sure you want to delete this match? This action cannot be undone.");
            if (!confirmation) {
                return;
            }

            await showCustomModal('loadingModal', 'Deleting match...');
            try {
                const matchRef = doc(db, "matches", matchIdToDelete);
                await deleteDoc(matchRef);
                // After deleting, refresh the list of matches
                await handleMyMatchesClick();
            } catch (error) {
                console.error("Error deleting match:", error);
                alert("Failed to delete match. Please try again.");
            } finally {
                await hideCustomModal('loadingModal');
            }
        }

        function listenToMatch(matchId) {
            currentMatchId = matchId;
            const matchRef = doc(db, `matches`, matchId);
            if (unsubscribeFromMatch) unsubscribeFromMatch();
            
            unsubscribeFromMatch = onSnapshot(matchRef, (doc) => {
                if (doc.exists()) {
                    matchData = doc.data();
                    renderUI();
                } else {
                    alert("Match has been deleted.");
                    goToHome();
                }
            });
        }
        
        // --- UI RENDERING & VIEWS ---
        function showView(viewId) {
            ['authView', 'homeView', 'scoreboardView', 'matchEndView', 'myMatchesView', 'playersView'].forEach(id => {
                document.getElementById(id).style.display = (id === viewId) ? 'block' : 'none';
            });
            const isLoggedIn = auth.currentUser !== null;
            document.getElementById('logoutBtn').style.display = isLoggedIn ? 'block' : 'none';
            document.getElementById('profileBtn').style.display = isLoggedIn ? 'block' : 'none';
            document.getElementById('myMatchesBtn').style.display = isLoggedIn ? 'block' : 'none';
            document.getElementById('playersBtn').style.display = isLoggedIn ? 'block' : 'none';
        }

        function goToHome() {
            if (unsubscribeFromMatch) unsubscribeFromMatch();
            currentMatchId = null;
            matchData = null;
            matchHistory = [];
            showView('homeView');
        }

        function renderUI() {
            if (!matchData) return;
            const isScorer = auth.currentUser && auth.currentUser.uid === matchData.creatorUid;

            if (matchData.gameState === 'finished') {
                showView('matchEndView');
                renderMatchEndView();
            } else if (matchData.gameState === 'setup') {
                 if(isScorer) {
                    showView('scoreboardView'); 
                    document.getElementById('scoringControls').style.display = 'none';
                    renderScoreboard();
                    showNewInningsModal();
                } else {
                    showView('scoreboardView');
                    renderScoreboard();
                    document.getElementById('scoringControls').style.display = 'none';
                }
            } else {
                showView('scoreboardView');
                renderScoreboard();
                document.getElementById('scoringControls').style.display = isScorer ? 'block' : 'none';
            }
        }
        
        function renderScoreboard() {
            const inning = matchData.innings[matchData.currentInning];
            if (!inning) return;
            const { battingTeam, bowlingTeam, runs, wickets, totalBalls, striker, nonStriker, bowler } = inning;
            const { completedOvers, ballsInOver } = calculateOvers(totalBalls);
            
            document.getElementById('battingTeamName').textContent = battingTeam;
            document.getElementById('bowlingTeamName').textContent = bowlingTeam;
            document.getElementById('scoreDisplay').textContent = `${runs}/${wickets}`;
            document.getElementById('oversDisplay').textContent = `(${completedOvers}.${ballsInOver} Overs)`;
            document.getElementById('strikerDisplay').textContent = `${striker?.name || '...'}*: ${striker?.runs || 0} (${striker?.balls || 0})`;
            document.getElementById('nonStrikerDisplay').textContent = `${nonStriker?.name || '...'}: ${nonStriker?.runs || 0} (${nonStriker?.balls || 0})`;
            const bowlerOvers = calculateOvers(bowler?.balls || 0);
            document.getElementById('bowlerDisplay').textContent = `Bowler: ${bowler?.name || '...'} (${bowlerOvers.completedOvers}.${bowlerOvers.ballsInOver} - ${bowler?.runsConceded || 0} - ${bowler?.wickets || 0})`;
            document.getElementById('matchIdDisplay').textContent = `ID: ${currentMatchId}`;
            
            const targetDisplay = document.getElementById('targetDisplay');
            if (matchData.currentInning === 2) {
                const target = (matchData.innings['1'].runs || 0) + 1;
                const runsNeeded = target - runs;
                const ballsRemaining = (matchData.oversPerInning * 6) - totalBalls;
                targetDisplay.textContent = (runsNeeded > 0 && ballsRemaining > 0) ? `${battingTeam} needs ${runsNeeded} in ${ballsRemaining} balls.` : `Target: ${target}`;
                targetDisplay.style.display = 'block';
            } else {
                targetDisplay.style.display = 'none';
            }
            
            renderLiveScorecards();

            if ((wickets >= 10 || completedOvers >= matchData.oversPerInning) && matchData.gameState === 'live') {
                endInnings();
            }
        }

        function renderLiveScorecards() {
            document.getElementById('liveScorecardInning1').innerHTML = createLiveScorecardHTML(matchData.innings['1'], matchData.currentInning === 1);
            const inning2Container = document.getElementById('liveScorecardInning2');
            if(matchData.currentInning === 2 || matchData.gameState === 'finished') {
                inning2Container.innerHTML = createLiveScorecardHTML(matchData.innings['2'], matchData.currentInning === 2);
                inning2Container.style.display = 'block';
            } else {
                inning2Container.style.display = 'none';
            }
        }
        
        function renderMatchEndView() {
            const { 1: i1, 2: i2 } = matchData.innings;
            let winner = i2.runs > i1.runs ? i2.battingTeam : (i1.runs > i2.runs ? i1.battingTeam : "Match Tied");
            let margin = i2.runs > i1.runs ? `${10 - i2.wickets} wickets` : (i1.runs > i2.runs ? `${i1.runs - i2.runs} runs` : "");
            document.getElementById('matchResultText').textContent = winner === "Match Tied" ? winner : `${winner} Won!`;
            document.getElementById('matchWinnerText').textContent = margin ? `Won by ${margin}` : "";
            document.getElementById('finalScorecards').innerHTML = `${createLiveScorecardHTML(i1, false)}${createLiveScorecardHTML(i2, false)}`;
        }

        // --- EVENT HANDLER & LOGIC FUNCTIONS ---
        
        async function handlePlayerSelection() {
            const inning = matchData.innings[matchData.currentInning];
            const inningPath = `innings.${matchData.currentInning}`;
            let updates = {};

            await hideCustomModal('playerSelectModal');

            if (matchData.gameState === 'setup') {
                const strikerName = document.getElementById('openingStrikerSelect')?.value || document.getElementById('openingStrikerInput')?.value.trim() || 'Batsman 1';
                const nonStrikerName = document.getElementById('openingNonStrikerSelect')?.value || document.getElementById('openingNonStrikerInput')?.value.trim() || 'Batsman 2';
                const bowlerName = document.getElementById('openingBowlerSelect')?.value || document.getElementById('openingBowlerInput')?.value.trim() || 'Bowler 1';
                updates = {
                    gameState: 'live',
                    [`${inningPath}.striker`]: createPlayerData(strikerName),
                    [`${inningPath}.nonStriker`]: createPlayerData(nonStrikerName),
                    [`${inningPath}.bowler`]: createBowlerData(bowlerName),
                    [`${inningPath}.battingOrder`]: [strikerName, nonStrikerName],
                    [`${inningPath}.bowlersUsed`]: [bowlerName]
                };
            } else if (matchData.gameState === 'wicket_wait') {
                const newBatsmanName = document.getElementById('newBatsmanSelectField')?.value || document.getElementById('newBatsmanInput')?.value.trim() || 'New Batsman';
                updates = { gameState: 'live' };
                updates[`${inningPath}.${matchData.outBatsman}`] = inning.battingStats[newBatsmanName] || createPlayerData(newBatsmanName);
                updates[`${inningPath}.battingOrder`] = [...new Set([...inning.battingOrder, newBatsmanName])];
            } else if(matchData.gameState === 'over_end_wait') {
                const newBowlerName = document.getElementById('newBowlerSelectField')?.value || document.getElementById('newBowlerInput')?.value.trim() || `Bowler ${inning.bowlersUsed.length + 1}`;
                updates = { gameState: 'live' };
                updates[`${inningPath}.bowlingStats.${inning.bowler.name}`] = inning.bowler;
                updates[`${inningPath}.bowler`] = inning.bowlingStats[newBowlerName] || createBowlerData(newBowlerName);
                updates[`${inningPath}.bowlersUsed`] = [...new Set([...inning.bowlersUsed, newBowlerName])];
            }
             await updateMatchData(updates);
        }
        
        async function handleScore(runs) {
            if (matchData.gameState !== 'live') return;
            const inningPath = `innings.${matchData.currentInning}`;
            const inning = matchData.innings[matchData.currentInning];
            const newTotalRuns = inning.runs + runs;

            let tempStriker = { ...inning.striker, runs: inning.striker.runs + runs, balls: inning.striker.balls + 1 };
            let tempBowler = { ...inning.bowler, balls: inning.bowler.balls + 1, runsConceded: inning.bowler.runsConceded + runs };
            const endOfOver = (inning.totalBalls + 1) % 6 === 0;
            const rotateStrike = (runs % 2 !== 0 && !endOfOver) || (runs % 2 === 0 && endOfOver);

            const updates = {
                [`${inningPath}.runs`]: newTotalRuns,
                [`${inningPath}.totalBalls`]: inning.totalBalls + 1,
                [`${inningPath}.bowler`]: tempBowler,
                [`${inningPath}.striker`]: rotateStrike ? inning.nonStriker : tempStriker,
                [`${inningPath}.nonStriker`]: rotateStrike ? tempStriker : inning.nonStriker
            };

            if (matchData.currentInning === 2 && newTotalRuns >= (matchData.innings['1'].runs + 1)) {
                return endInnings(updates);
            }

            if (endOfOver && calculateOvers(inning.totalBalls + 1).completedOvers < matchData.oversPerInning) {
                updates['gameState'] = 'over_end_wait';
                await updateMatchData(updates);
                showNewBowlerModal();
            } else {
                 await updateMatchData(updates);
            }
        }
        
        async function handleExtra(type, extraRuns = 0) {
            if (matchData.gameState !== 'live') return;
            const inningPath = `innings.${matchData.currentInning}`;
            const inning = matchData.innings[matchData.currentInning];
            const penaltyRun = (type === 'nb' || type === 'wd') ? 1 : 0;
            const newTotalRuns = inning.runs + penaltyRun + extraRuns;

            const updates = { [`${inningPath}.runs`]: newTotalRuns };
            
            if(type === 'nb') {
                updates[`${inningPath}.striker.runs`] = inning.striker.runs + extraRuns;
                updates[`${inningPath}.bowler.runsConceded`] = inning.bowler.runsConceded + penaltyRun + extraRuns;
            } else if (type === 'wd') {
                 updates[`${inningPath}.bowler.runsConceded`] = inning.bowler.runsConceded + penaltyRun + extraRuns;
            } else { // Byes or Leg Byes
                updates[`${inningPath}.totalBalls`] = inning.totalBalls + 1;
            }
            
            if (matchData.currentInning === 2 && newTotalRuns >= (matchData.innings['1'].runs + 1)) {
                return endInnings(updates);
            }
            await updateMatchData(updates);
        }

        async function handleWicket() {
            if (matchData.gameState !== 'live') return;
            
            const outBatsman = document.querySelector('input[name="outBatsmanRadio"]:checked').value;
            const inningPath = `innings.${matchData.currentInning}`;
            const inning = matchData.innings[matchData.currentInning];
            const outBatsmanData = { ...(inning[outBatsman] || {}), isOut: true };

            const updates = {
                [`${inningPath}.wickets`]: inning.wickets + 1,
                [`${inningPath}.totalBalls`]: inning.totalBalls + 1,
                [`${inningPath}.bowler.balls`]: inning.bowler.balls + 1,
                [`${inningPath}.bowler.wickets`]: inning.bowler.wickets + 1,
                [`${inningPath}.battingStats.${outBatsmanData.name}`]: outBatsmanData,
                gameState: 'wicket_wait',
                outBatsman
            };
            
            await hideCustomModal('wicketModal');
            await updateMatchData(updates);

            if (inning.wickets + 1 >= 10) {
                 endInnings();
            } else {
                showNewBatsmanModal();
            }
        }
        
        async function handleUndo() {
            if (matchHistory.length === 0) {
                return alert("Nothing to undo.");
            }
            const stateToRestore = matchHistory.pop();
            await showCustomModal('loadingModal', 'Undoing...');
            try {
                const matchRef = doc(db, "matches", currentMatchId);
                await setDoc(matchRef, stateToRestore);
            } catch (error) {
                console.error("Failed to undo state:", error);
                matchHistory.push(stateToRestore);
            } finally {
                await hideCustomModal('loadingModal');
            }
        }

        async function endInnings(finalUpdates = {}) {
            const inningPath = `innings.${matchData.currentInning}`;
            const inning = matchData.innings[matchData.currentInning];
            const updates = { ...finalUpdates };
            
            if(inning.striker.name) updates[`${inningPath}.battingStats.${inning.striker.name}`] = inning.striker;
            if(inning.nonStriker.name) updates[`${inningPath}.battingStats.${inning.nonStriker.name}`] = inning.nonStriker;
            if(inning.bowler.name) updates[`${inningPath}.bowlingStats.${inning.bowler.name}`] = inning.bowler;

            if (matchData.currentInning === 1) {
                updates.currentInning = 2;
                updates.gameState = 'setup';
            } else {
                updates.gameState = 'finished';
            }
            await updateMatchData(updates);
        }
        
        async function swapBatsmen() {
            if (matchData.gameState !== 'live') return;
            const inningPath = `innings.${matchData.currentInning}`;
            const inning = matchData.innings[matchData.currentInning];
            await updateMatchData({
                [`${inningPath}.striker`]: inning.nonStriker,
                [`${inningPath}.nonStriker`]: inning.striker
            });
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        
        function createInningData(battingTeam, bowlingTeam) {
            return { battingTeam, bowlingTeam, runs: 0, wickets: 0, totalBalls: 0, striker: {}, nonStriker: {}, bowler: {}, battingStats: {}, bowlingStats: {}, battingOrder: [], bowlersUsed: [] };
        }
        function createPlayerData(name) { return { name, runs: 0, balls: 0, isOut: false }; }
        function createBowlerData(name) { return { name, balls: 0, runsConceded: 0, wickets: 0 }; }

        async function updateMatchData(updates) {
            if (!currentMatchId) return;
            if (matchData && auth.currentUser?.uid === matchData.creatorUid) {
                matchHistory.push(JSON.parse(JSON.stringify(matchData)));
                if (matchHistory.length > 20) matchHistory.shift(); 
            }
            await showCustomModal('loadingModal', 'Updating...');
            try {
                const matchRef = doc(db, "matches", currentMatchId);
                await updateDoc(matchRef, updates);
            } catch (error) {
                console.error("Failed to update match data:", error);
                if (auth.currentUser?.uid === matchData?.creatorUid) matchHistory.pop();
            } finally {
                await hideCustomModal('loadingModal');
            }
        }
        
        function calculateOvers(balls) {
            if (typeof balls !== 'number' || balls < 0) return { completedOvers: 0, ballsInOver: 0};
            return { completedOvers: Math.floor(balls / 6), ballsInOver: balls % 6 };
        }
        function generateMatchId() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }
        
        function copyMatchId() {
            if (!currentMatchId) return;
            const textArea = document.createElement("textarea");
            textArea.value = currentMatchId;
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.select();
            let success = false;
            try { success = document.execCommand('copy'); } catch (err) { console.error('Copy failed', err); }
            document.body.removeChild(textArea);
            const display = document.getElementById('matchIdDisplay');
            const originalText = display.textContent;
            display.textContent = success ? "Copied!" : "Copy Failed!";
            setTimeout(() => { if (display.textContent !== originalText) display.textContent = originalText; }, 1500);
        }

        function showWicketModal() {
            document.getElementById('outStrikerLabel').textContent = document.getElementById('strikerDisplay').textContent;
            document.getElementById('outNonStrikerLabel').textContent = document.getElementById('nonStrikerDisplay').textContent;
            showCustomModal('wicketModal');
        }

        function buildPlayerSelect(label, id, players, disabledOptions = []) {
            let options = '<option value="">Select a player</option>';
            players.forEach(p => {
                const isDisabled = disabledOptions.includes(p);
                options += `<option value="${p}" ${isDisabled ? 'disabled' : ''}>${p}</option>`;
            });
            return `<div class="mb-3"><label class="form-label">${label}</label><select id="${id}" class="form-select">${options}</select></div>`;
        }

        function buildPlayerInput(label, id) {
            return `<div class="mb-3"><label class="form-label">${label}</label><input type="text" id="${id}" class="form-control" placeholder="Enter name"></div>`;
        }
        
        function showNewInningsModal() {
            const inningNumber = matchData.currentInning;
            const battingTeamName = matchData.innings[inningNumber].battingTeam;
            const bowlingTeamName = matchData.innings[inningNumber].bowlingTeam;

            const isBattingTeamPremade = (battingTeamName === matchData.teamAName) ? matchData.isTeamApremade : matchData.isTeamBpremade;
            const isBowlingTeamPremade = (bowlingTeamName === matchData.teamAName) ? matchData.isTeamBpremade : matchData.isTeamApremade;

            const battingTeam = userTeams.find(t => t.name === battingTeamName);
            const bowlingTeam = userTeams.find(t => t.name === bowlingTeamName);
            
            const container = document.getElementById('initialPlayerSelect');
            container.innerHTML = isBattingTeamPremade ?
                buildPlayerSelect('Opening Batsman (Striker)', 'openingStrikerSelect', battingTeam?.players || []) + buildPlayerSelect('Opening Batsman (Non-Striker)', 'openingNonStrikerSelect', battingTeam?.players || []) :
                buildPlayerInput('Opening Batsman (Striker)', 'openingStrikerInput') + buildPlayerInput('Opening Batsman (Non-Striker)', 'openingNonStrikerInput');
            
            container.innerHTML += isBowlingTeamPremade ?
                buildPlayerSelect('Opening Bowler', 'openingBowlerSelect', bowlingTeam?.players || []) :
                buildPlayerInput('Opening Bowler', 'openingBowlerInput');
            
            if(isBattingTeamPremade) {
                const strikerSelect = document.getElementById('openingStrikerSelect');
                const nonStrikerSelect = document.getElementById('openingNonStrikerSelect');
                strikerSelect.addEventListener('change', () => updateBatsmanOptions('openingStrikerSelect', 'openingNonStrikerSelect', battingTeam?.players || []));
                nonStrikerSelect.addEventListener('change', () => updateBatsmanOptions('openingNonStrikerSelect', 'openingStrikerSelect', battingTeam?.players || []));
            }
            
            document.getElementById('initialPlayerSelect').style.display = 'block';
            document.getElementById('newBatsmanSelect').style.display = 'none';
            document.getElementById('newBowlerSelect').style.display = 'none';
            document.getElementById('playerSelectTitle').textContent = `Start Inning ${inningNumber}: ${battingTeamName}`;
            showCustomModal('playerSelectModal');
        }

        function showNewBatsmanModal() {
            const inning = matchData.innings[matchData.currentInning];
            const battingTeamName = inning.battingTeam;
            const isBattingTeamPremade = (battingTeamName === matchData.teamAName) ? matchData.isTeamApremade : matchData.isTeamBpremade;
            const battingTeam = userTeams.find(t => t.name === battingTeamName);
            
            const notOutBatsmanAtCrease = matchData.outBatsman === 'striker' ? inning.nonStriker?.name : inning.striker?.name;
            const outBatsmenNames = Object.keys(inning.battingStats);
            const availableBatsmen = battingTeam?.players.filter(p => p !== notOutBatsmanAtCrease && !outBatsmenNames.includes(p)) || [];

            const container = document.getElementById('newBatsmanSelect');
            container.innerHTML = isBattingTeamPremade ? buildPlayerSelect('New Batsman', 'newBatsmanSelectField', availableBatsmen) : buildPlayerInput('New Batsman', 'newBatsmanInput');
            
            document.getElementById('initialPlayerSelect').style.display = 'none';
            container.style.display = 'block';
            document.getElementById('newBowlerSelect').style.display = 'none';
            document.getElementById('playerSelectTitle').textContent = `Wicket! Who is the next batsman?`;
            showCustomModal('playerSelectModal');
        }
         function showNewBowlerModal() {
            const inning = matchData.innings[matchData.currentInning];
            const bowlingTeamName = inning.bowlingTeam;
            const isBowlingTeamPremade = (bowlingTeamName === matchData.teamAName) ? matchData.isTeamApremade : matchData.isTeamBpremade;
            const bowlingTeam = userTeams.find(t => t.name === bowlingTeamName);
            const lastBowler = inning.bowler.name;
            const availableBowlers = bowlingTeam?.players.filter(p => p !== lastBowler) || [];

            const container = document.getElementById('newBowlerSelect');
            container.innerHTML = isBowlingTeamPremade ? buildPlayerSelect('New Bowler', 'newBowlerSelectField', availableBowlers) : buildPlayerInput('New Bowler', 'newBowlerInput');

            document.getElementById('initialPlayerSelect').style.display = 'none';
            document.getElementById('newBatsmanSelect').style.display = 'none';
            container.style.display = 'block';
            document.getElementById('playerSelectTitle').textContent = `End of Over. Select New Bowler.`;
            showCustomModal('playerSelectModal');
        }
        
        function updateBatsmanOptions(primaryId, secondaryId, allPlayers) {
            const primarySelect = document.getElementById(primaryId);
            const secondarySelect = document.getElementById(secondaryId);
            if(!primarySelect || !secondarySelect) return;
            const primaryValue = primarySelect.value;
            const secondaryValue = secondarySelect.value;
            
            secondarySelect.innerHTML = '';
            let options = '<option value="">Select a player</option>';
            allPlayers.forEach(p => {
                if(p !== primaryValue) {
                    options += `<option value="${p}">${p}</option>`;
                }
            });
            secondarySelect.innerHTML = options;
            if(secondaryValue && secondaryValue !== primaryValue) {
                secondarySelect.value = secondaryValue;
            }
        }
        
        function showExtraModal(type) {
            const modalTitle = document.getElementById('extraModalTitle');
            const runsLabel = document.querySelector('#extraModal .form-label');
            
            if (type === 'nb') {
                modalTitle.textContent = 'No Ball';
                runsLabel.textContent = 'Runs scored off the bat (in addition to the no ball)?';
            } else if (type === 'wd') {
                modalTitle.textContent = 'Wide';
                runsLabel.textContent = 'How many additional runs were taken (e.g., overthrows)?';
            } else if (type === 'b') {
                modalTitle.textContent = 'Byes';
                runsLabel.textContent = 'How many byes were run?';
            } else if (type === 'lb') {
                modalTitle.textContent = 'Leg Byes';
                runsLabel.textContent = 'How many leg byes were run?';
            }
            document.getElementById('extraRunsInput').value = 0;
            document.getElementById('confirmExtraBtn').onclick = () => {
                const runs = parseInt(document.getElementById('extraRunsInput').value) || 0;
                handleExtra(type, runs);
                hideCustomModal('extraModal');
            };
            showCustomModal('extraModal');
        }

        // --- Custom Modal Functions ---
        function showCustomModal(modalId, text) {
            const modal = document.getElementById(modalId);
            if (text) document.getElementById('loadingText').textContent = text;
            if (modal) modal.style.display = 'flex';
        }
        function hideCustomModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }
        
        function createLiveScorecardHTML(inningData, isCurrentInning) {
            if (!inningData) return '';
            let battingRows = '';
            const processedBatsmen = new Set();
        
            // Determine the full player list for the batting team
            const battingTeamData = userTeams.find(t => t.name === inningData.battingTeam);
            const fullBattingList = battingTeamData ? battingTeamData.players : inningData.battingOrder;
            
            for (const playerName of fullBattingList) {
                if (processedBatsmen.has(playerName)) continue;
                
                let stats;
                if (isCurrentInning && inningData.striker?.name === playerName) stats = inningData.striker;
                else if (isCurrentInning && inningData.nonStriker?.name === playerName) stats = inningData.nonStriker;
                else stats = inningData.battingStats[playerName];
                
                const runs = stats?.runs ?? "-";
                const balls = stats?.balls ?? "-";
                const isOut = stats?.isOut;
                const status = isOut ? "out" : (isCurrentInning && (inningData.striker?.name === playerName || inningData.nonStriker?.name === playerName)) ? 'not out' : 'yet to bat';

                battingRows += `<tr><td>${playerName}${isCurrentInning && (inningData.striker?.name === playerName) ? '*' : ''}</td><td>${status}</td><td class="fw-bold">${runs}</td><td>${balls}</td></tr>`;
                processedBatsmen.add(playerName);
            }

            let bowlingRows = '';
            const processedBowlers = new Set();
            const fullBowlerList = [...new Set([...inningData.bowlersUsed, inningData.bowler?.name].filter(Boolean))];

            for (const bowlerName of fullBowlerList) {
                if (processedBowlers.has(bowlerName)) continue;
                let stats = (isCurrentInning && inningData.bowler?.name === bowlerName) ? inningData.bowler : inningData.bowlingStats[bowlerName];

                 if (stats && stats.name) {
                    const { completedOvers, ballsInOver } = calculateOvers(stats.balls);
                    bowlingRows += `<tr><td>${stats.name}</td><td>${completedOvers}.${ballsInOver}</td><td>${stats.runsConceded}</td><td class="fw-bold">${stats.wickets}</td></tr>`;
                    processedBowlers.add(bowlerName);
                 }
            }
            
            const { completedOvers, ballsInOver } = calculateOvers(inningData.totalBalls);
            return `<div class="card mb-3"><div class="card-header bg-light text-dark fw-bold">${inningData.battingTeam} - ${inningData.runs}/${inningData.wickets} (${completedOvers}.${ballsInOver} Overs)</div><div class="card-body"><h6 class="fw-bold">Batting</h6><div class="table-responsive"><table class="table table-sm mb-0"><thead><tr><th>Batsman</th><th>Status</th><th>Runs</th><th>Balls</th></tr></thead><tbody>${battingRows}</tbody></table></div><h6 class="fw-bold mt-3">Bowling</h6><div class="table-responsive"><table class="table table-sm mb-0"><thead><tr><th>Bowler</th><th>Overs</th><th>Runs</th><th>Wickets</th></tr></thead><tbody>${bowlingRows}</tbody></table></div></div></div>`;
        }

        // --- Expose functions to global scope ---
        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;
        window.handleLogout = handleLogout;
        window.handleForgotPassword = handleForgotPassword;
        window.showProfileModal = showProfileModal;
        window.createMatch = createMatch;
        window.joinMatch = joinMatch;
        window.handlePlayerSelection = handlePlayerSelection;
        window.handleWicket = handleWicket;
        window.copyMatchId = copyMatchId;
        window.handleSaveTeam = handleSaveTeam;
        window.handleScore = handleScore;
        window.handleExtra = handleExtra;
        window.swapBatsmen = swapBatsmen;
        window.endInnings = endInnings;
        window.showCustomModal = showCustomModal;
        window.hideCustomModal = hideCustomModal;
        window.showWicketModal = showWicketModal;
        window.goToHome = goToHome;
        window.handleUndo = handleUndo;
        window.handleDeleteMatch = handleDeleteMatch;
        window.addPlayer = addPlayer;
        window.deletePlayer = deletePlayer;
        window.handleMyMatchesClick = handleMyMatchesClick;
        window.handlePlayersClick = handlePlayersClick;
        window.handleDeleteTeam = handleDeleteTeam;
        window.showExtraModal = showExtraModal;

    </script>
</body>
</html>
